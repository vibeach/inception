{% extends "base.html" %}

{% block title %}Incept - {{ project.name }}{% endblock %}

{% block content %}
<style>
/* Progress Timeline */
.progress-timeline { display: flex; gap: 4px; margin-top: 8px; }
.progress-dots { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
.progress-dot { width: 6px; height: 6px; border-radius: 50%; }
.progress-dot.info { background: #60a5fa; }
.progress-dot.success { background: #10b981; }
.progress-dot.error { background: #ef4444; }
.progress-dot.warning { background: #f59e0b; }
.timeline-separator { width: 8px; height: 1px; background: #334155; }
.timeline-loading { font-size: 0.75rem; color: #94a3b8; }

/* Git Status Panel */
.git-status-section { background: #1e293b; padding: 20px; border-radius: 8px; margin-top: 20px; }
.git-status-content { background: #0f172a; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 14px; }
.git-branch { color: #60a5fa; font-weight: 600; margin-bottom: 10px; }
.git-ahead-badge { display: inline-block; background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
.git-file-group { margin-top: 15px; }
.git-file-group-title { color: #94a3b8; font-weight: 600; margin-bottom: 8px; }
.git-file { padding: 6px 10px; margin-bottom: 4px; background: #1e293b; border-left: 3px solid #334155; border-radius: 4px; }
.git-file.modified { border-left-color: #f59e0b; }
.git-file.staged { border-left-color: #10b981; }
.git-file.untracked { border-left-color: #94a3b8; }

/* Restart Modal */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal-content { background: #1e293b; padding: 30px; border-radius: 12px; min-width: 400px; max-width: 90%; }
.modal-content h3 { margin-bottom: 20px; color: #60a5fa; }
.modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 style="font-size: 28px; color: #60a5fa;">Incept: {{ project.name }}</h1>
    <a href="/projects/{{ project.id }}" class="btn btn-secondary">‚Üê Back to Project</a>
</div>

<!-- Submit Request Form -->
<div class="card">
    <h2>Submit Improvement Request</h2>
    <form id="request-form" style="margin-top: 15px;">
        <div class="form-group">
            <label for="request-text">What would you like to improve?</label>
            <textarea id="request-text" rows="4" placeholder="Example: Add a dark mode toggle to the settings page"></textarea>
        </div>

        <div class="grid grid-2" style="margin-bottom: 15px;">
            <div class="form-group">
                <label>Processing Mode</label>
                <div style="display: flex; gap: 0; border-radius: 6px; overflow: hidden; border: 1px solid #334155;">
                    <button type="button" class="mode-btn {% if settings.mode == 'api' %}active{% endif %}" data-mode="api" title="Uses API credits" style="flex: 1; padding: 10px; border: none; background: {% if settings.mode == 'api' %}#60a5fa{% else %}#0f172a{% endif %}; color: white; cursor: pointer;">
                        API
                    </button>
                    <button type="button" class="mode-btn {% if settings.mode == 'cli_token' %}active{% endif %}" data-mode="cli_token" title="Uses Claude Code OAuth (Max subscription)" style="flex: 1; padding: 10px; border: none; border-left: 1px solid #334155; background: {% if settings.mode == 'cli_token' %}#60a5fa{% else %}#0f172a{% endif %}; color: white; cursor: pointer;">
                        CLI Token
                    </button>
                </div>
                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                    API Key: {% if has_api_key %}<span style="color: #10b981;">‚úì</span>{% else %}<span style="color: #ef4444;">‚úó</span>{% endif %} |
                    OAuth Token: {% if has_oauth_token %}<span style="color: #10b981;">‚úì</span>{% else %}<span style="color: #ef4444;">‚úó</span>{% endif %}
                </div>
            </div>
            <div class="form-group">
                <label for="model">Model</label>
                <select id="model">
                    <option value="claude-sonnet-4-20250514" {% if settings.model == 'claude-sonnet-4-20250514' %}selected{% endif %}>Claude Sonnet 4</option>
                    <option value="claude-opus-4-20250514" {% if settings.model == 'claude-opus-4-20250514' %}selected{% endif %}>Claude Opus 4</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="auto-push">
                <input type="checkbox" id="auto-push" checked style="width: auto; margin-right: 5px;">
                Auto-push to git
            </label>
        </div>

        <button type="submit" class="btn btn-primary">Submit Request</button>
    </form>
</div>

<!-- Requests List -->
<div class="card">
    <h2>Request History</h2>
    <div id="requests-list" style="margin-top: 15px;">
        {% if requests %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Request</th>
                    <th>Status</th>
                    <th>Model</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                <tr id="request-{{ req.id }}">
                    <td>#{{ req.id }}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        {{ req.text }}
                        <div class="progress-timeline" data-req-id="{{ req.id }}">
                            <div class="timeline-loading">Loading...</div>
                        </div>
                    </td>
                    <td><span class="badge badge-{{ req.status }}">{{ req.status }}</span></td>
                    <td style="font-size: 12px; color: #94a3b8;">{{ req.model }}</td>
                    <td style="color: #94a3b8; font-size: 12px;">{{ req.created_at }}</td>
                    <td>
                        <button onclick="viewLogs({{ req.id }})" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                            Logs
                        </button>
                        {% if req.status == 'pending' %}
                        <button onclick="cancelRequest({{ req.id }})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                            Cancel
                        </button>
                        {% elif req.status in ['completed', 'error'] %}
                        <button onclick="showRestartModal({{ req.id }}, '{{ req.mode }}', '{{ req.model }}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                            Restart
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #64748b;">No requests yet. Submit your first improvement request above!</p>
        {% endif %}
    </div>
</div>

<!-- Git Status Panel -->
<div class="git-status-section card">
    <h2>Git Status</h2>
    <div class="git-status-content" id="git-status-content">
        <div style="color: #94a3b8;">Loading git status...</div>
    </div>
</div>

<!-- Logs Modal (will be populated dynamically) -->
<div id="logs-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 40px;">
    <div style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; max-width: 900px; margin: 0 auto; max-height: 80vh; display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="logs-title" style="color: #60a5fa;">Request Logs</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="copyFullLog()" class="btn btn-primary" id="copy-log-btn" style="display: none;">
                    üìã Copy Full Log
                </button>
                <button onclick="closeLogs()" class="btn btn-secondary">Close</button>
            </div>
        </div>
        <div id="log-file-info" style="padding: 10px 20px; background: #0f172a; border-bottom: 1px solid #334155; font-size: 12px; color: #94a3b8; display: none;">
            <!-- Log file path will be shown here -->
        </div>
        <div id="logs-content" style="padding: 20px; overflow-y: auto; flex: 1; font-family: monospace; font-size: 13px;">
            <!-- Logs will be inserted here -->
        </div>
    </div>
</div>

<!-- Restart Modal -->
<div id="restart-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Restart Request</h3>
        <div class="form-group">
            <label for="restart-mode">Mode:</label>
            <select id="restart-mode" style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                <option value="api">API</option>
                <option value="cli_token">CLI Token</option>
            </select>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label for="restart-model">Model:</label>
            <select id="restart-model" style="width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white;">
                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                <option value="claude-opus-4-20250514">Claude Opus 4</option>
            </select>
        </div>
        <div class="modal-actions">
            <button onclick="confirmRestart()" class="btn btn-primary">Restart</button>
            <button onclick="closeRestartModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};

// Mode button handling
document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const mode = this.dataset.mode;

        // Update UI
        document.querySelectorAll('.mode-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = '#0f172a';
        });
        this.classList.add('active');
        this.style.background = '#60a5fa';

        // Save to backend
        await saveSettings();
    });
});

// Save settings
async function saveSettings() {
    const mode = document.querySelector('.mode-btn.active').dataset.mode;
    const model = document.getElementById('model').value;

    try {
        await fetch(`/api/incept/settings/${projectId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mode, model })
        });
    } catch (err) {
        console.error('Failed to save settings:', err);
    }
}

// Model change
document.getElementById('model').addEventListener('change', saveSettings);

// Submit request
document.getElementById('request-form').onsubmit = async (e) => {
    e.preventDefault();

    const text = document.getElementById('request-text').value.trim();
    if (!text) {
        alert('Please enter a request');
        return;
    }

    const mode = document.querySelector('.mode-btn.active').dataset.mode;

    const response = await fetch('/api/incept/request', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            project_id: projectId,
            text: text,
            mode: mode,
            model: document.getElementById('model').value,
            auto_push: document.getElementById('auto-push').checked
        })
    });

    if (response.ok) {
        alert('Request submitted!');
        document.getElementById('request-text').value = '';
        location.reload();
    } else {
        alert('Error submitting request');
    }
};

// Store current request ID for copying
let currentReqId = null;
let fullLogContent = null;

// View logs
async function viewLogs(reqId) {
    currentReqId = reqId;
    const response = await fetch(`/api/incept/request/${reqId}/logs`);
    const data = await response.json();

    document.getElementById('logs-title').textContent = `Request #${reqId} Logs`;

    const logsHtml = data.logs.map(log => {
        const color = {
            'info': '#94a3b8',
            'success': '#10b981',
            'warning': '#fbbf24',
            'error': '#ef4444',
            'debug': '#8b5cf6'
        }[log.log_type] || '#94a3b8';

        return `<div style="margin-bottom: 10px; color: ${color};">
            [${log.timestamp}] [${log.log_type.toUpperCase()}] ${log.message}
        </div>`;
    }).join('');

    document.getElementById('logs-content').innerHTML = logsHtml || '<p style="color: #64748b;">No logs yet</p>';

    // Try to fetch full log file
    try {
        const fullLogResponse = await fetch(`/api/incept/request/${reqId}/full-log`);
        if (fullLogResponse.ok) {
            const fullLogData = await fullLogResponse.json();
            fullLogContent = fullLogData.content;

            if (fullLogData.log_file) {
                document.getElementById('log-file-info').style.display = 'block';
                document.getElementById('log-file-info').innerHTML = `
                    üìÅ Detailed log saved to: <code style="color: #60a5fa;">${fullLogData.log_file}</code>
                `;
                document.getElementById('copy-log-btn').style.display = 'block';
            }
        }
    } catch (e) {
        // No full log available yet
        fullLogContent = null;
        document.getElementById('log-file-info').style.display = 'none';
        document.getElementById('copy-log-btn').style.display = 'none';
    }

    document.getElementById('logs-modal').style.display = 'block';
}

async function copyFullLog() {
    if (!fullLogContent) {
        alert('Full log not available');
        return;
    }

    try {
        await navigator.clipboard.writeText(fullLogContent);
        const btn = document.getElementById('copy-log-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    } catch (err) {
        alert('Failed to copy log to clipboard');
    }
}

function closeLogs() {
    document.getElementById('logs-modal').style.display = 'none';
    currentReqId = null;
    fullLogContent = null;
}

// Progress Timeline Loader
async function loadProgressTimelines() {
    const timelines = document.querySelectorAll('.progress-timeline');
    for (const timeline of timelines) {
        const reqId = timeline.dataset.reqId;
        try {
            const response = await fetch(`/api/incept/request/${reqId}/logs`);
            const data = await response.json();

            if (!data.success || !data.logs || data.logs.length === 0) {
                timeline.innerHTML = '';
                continue;
            }

            let html = '<div class="progress-dots">';
            data.logs.forEach((log, idx) => {
                const dotClass = log.log_type || 'info';
                html += `<span class="progress-dot ${dotClass}" title="${log.message} - ${new Date(log.timestamp).toLocaleString()}"></span>`;
                if ((idx + 1) % 5 === 0 && idx < data.logs.length - 1) {
                    html += '<div class="timeline-separator"></div>';
                }
            });
            html += '</div>';
            timeline.innerHTML = html;
        } catch (err) {
            timeline.innerHTML = '';
        }
    }
}

// Git Status Loader
async function loadGitStatus() {
    try {
        const response = await fetch(`/api/git/status/${projectId}`);
        const data = await response.json();

        let html = '';
        if (data.error) {
            html = `<div style="color: #ef4444;">${data.error}</div>`;
        } else {
            html = `<div class="git-branch">Branch: ${data.branch}`;
            if (data.ahead > 0) {
                html += `<span class="git-ahead-badge">‚Üë ${data.ahead} ahead</span>`;
            }
            if (data.behind > 0) {
                html += `<span class="git-ahead-badge" style="background: #f59e0b;">‚Üì ${data.behind} behind</span>`;
            }
            html += '</div>';

            if (data.staged && data.staged.length > 0) {
                html += '<div class="git-file-group"><div class="git-file-group-title">Staged:</div>';
                data.staged.forEach(file => {
                    html += `<div class="git-file staged">${file}</div>`;
                });
                html += '</div>';
            }

            if (data.modified && data.modified.length > 0) {
                html += '<div class="git-file-group"><div class="git-file-group-title">Modified:</div>';
                data.modified.forEach(file => {
                    html += `<div class="git-file modified">${file}</div>`;
                });
                html += '</div>';
            }

            if (data.untracked && data.untracked.length > 0) {
                html += '<div class="git-file-group"><div class="git-file-group-title">Untracked:</div>';
                data.untracked.forEach(file => {
                    html += `<div class="git-file untracked">${file}</div>`;
                });
                html += '</div>';
            }

            if (!data.staged.length && !data.modified.length && !data.untracked.length) {
                html += '<div style="color: #10b981; margin-top: 10px;">‚úì Working tree clean</div>';
            }
        }

        document.getElementById('git-status-content').innerHTML = html;
    } catch (err) {
        document.getElementById('git-status-content').innerHTML = `<div style="color: #ef4444;">Error loading git status</div>`;
    }
}

// Restart Modal
let restartRequestId = null;

function showRestartModal(reqId, currentMode, currentModel) {
    restartRequestId = reqId;
    document.getElementById('restart-mode').value = currentMode || 'api';
    document.getElementById('restart-model').value = currentModel || 'claude-sonnet-4-20250514';
    document.getElementById('restart-modal').style.display = 'flex';
}

function closeRestartModal() {
    document.getElementById('restart-modal').style.display = 'none';
    restartRequestId = null;
}

async function confirmRestart() {
    const mode = document.getElementById('restart-mode').value;
    const model = document.getElementById('restart-model').value;

    try {
        const response = await fetch(`/api/incept/request/${restartRequestId}/restart`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ mode, model })
        });
        const data = await response.json();

        if (data.success) {
            closeRestartModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error restarting request');
    }
}

// Cancel request
async function cancelRequest(reqId) {
    if (!confirm('Cancel this request?')) return;

    await fetch(`/api/incept/request/${reqId}/cancel`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });

    location.reload();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProgressTimelines();
    loadGitStatus();

    // Refresh every 30 seconds
    setInterval(loadProgressTimelines, 30000);
    setInterval(loadGitStatus, 30000);
});

// Auto-refresh pending requests
setInterval(async () => {
    const response = await fetch(`/api/incept/requests/${projectId}`);
    const data = await response.json();

    // Update status badges
    data.requests.forEach(req => {
        const row = document.getElementById(`request-${req.id}`);
        if (row) {
            const badge = row.querySelector('.badge');
            if (badge && badge.textContent !== req.status) {
                location.reload(); // Reload if status changed
            }
        }
    });
}, 5000); // Check every 5 seconds
</script>
{% endblock %}
